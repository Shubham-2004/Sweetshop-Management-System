<div class="dashboard-container">
  <!-- Header -->
  <header class="dashboard-header">
    <div class="header-content">
      <div class="brand">
        <h1>🍭 Kata Sweet Shop Dashboard</h1>
        <span class="user-info">Welcome, {{ currentUser }} 
          <span class="role-badge" [class.admin]="isAdmin">{{ isAdmin ? 'ADMIN' : 'USER' }}</span>
        </span>
      </div>
      <button class="btn-logout" (click)="logout()">Logout</button>
    </div>
  </header>

  <!-- Search and Filter Section -->
  <section class="search-section">
    <div class="search-container">
      <h2>Search & Filter Sweets</h2>
      <div class="search-form">
        <div class="search-row">
          <input 
            type="text" 
            placeholder="Search by name..." 
            [(ngModel)]="searchName"
            class="search-input">
          <input 
            type="text" 
            placeholder="Filter by category..." 
            [(ngModel)]="searchCategory"
            class="search-input">
        </div>
        <div class="search-row">
          <input 
            type="number" 
            placeholder="Min price" 
            [(ngModel)]="minPrice"
            min="0" 
            step="0.01"
            class="search-input">
          <input 
            type="number" 
            placeholder="Max price" 
            [(ngModel)]="maxPrice"
            min="0" 
            step="0.01"
            class="search-input">
        </div>
        <div class="search-buttons">
          <button class="btn-search" (click)="searchSweets()">🔍 Search</button>
          <button class="btn-clear" (click)="clearSearch()">🗑️ Clear</button>
        </div>
      </div>
    </div>
  </section>

  <!-- Admin Controls -->
  <section class="admin-section" *ngIf="isAdmin">
    <div class="admin-controls">
      <h2>Admin Controls</h2>
      <button class="btn-add" (click)="showAddSweetForm()">➕ Add New Sweet</button>
    </div>
  </section>

  <!-- Loading Indicator -->
  <div class="loading" *ngIf="isLoading">
    <div class="spinner"></div>
    <p>Loading sweets...</p>
  </div>

  <!-- Sweets Display -->
  <section class="sweets-section" *ngIf="!isLoading">
    <div class="sweets-header">
      <h2>Available Sweets ({{ filteredSweets.length }})</h2>
    </div>
    
    <div class="sweets-grid" *ngIf="filteredSweets.length > 0; else noSweets">
      <div class="sweet-card" *ngFor="let sweet of filteredSweets">
        <div class="sweet-info">
          <h3>{{ sweet.name }}</h3>
          <p class="category">{{ sweet.category }}</p>
          <p class="description" *ngIf="sweet.description">{{ sweet.description }}</p>
          <div class="price-quantity">
            <span class="price">${{ sweet.price?.toFixed(2) || '0.00' }}</span>
            <span class="quantity" [class.out-of-stock]="sweet.quantity === 0">
              Stock: {{ sweet.quantity || 0 }}
            </span>
          </div>
        </div>

        <!-- Purchase Controls -->
        <div class="purchase-controls" *ngIf="sweet.quantity && sweet.quantity > 0">
          <div class="quantity-selector">
            <label>Qty:</label>
            <input 
              type="number" 
              [value]="getValidQuantity(sweet.id, sweet.quantity)"
              (input)="updatePurchaseQuantity(sweet.id, $event, sweet.quantity)"
              (blur)="validatePurchaseQuantity(sweet.id, sweet.quantity)"
              min="1" 
              [max]="sweet.quantity"
              class="quantity-input">
          </div>
          <button 
            class="btn-purchase" 
            (click)="purchaseSweet(sweet)"
            [disabled]="!isValidPurchaseQuantity(sweet.id, sweet.quantity)">
            🛒 Purchase
          </button>
        </div>

        <div class="out-of-stock-message" *ngIf="!sweet.quantity || sweet.quantity === 0">
          <span>❌ Out of Stock</span>
        </div>

        <!-- Admin Controls -->
        <div class="admin-controls-card" *ngIf="isAdmin">
          <button class="btn-edit" (click)="editSweet(sweet)">✏️ Edit</button>
          <button class="btn-restock" (click)="restockSweet(sweet)">📦 Restock</button>
          <button class="btn-delete" (click)="deleteSweet(sweet)">🗑️ Delete</button>
        </div>
      </div>
    </div>

    <ng-template #noSweets>
      <div class="no-sweets">
        <p>No sweets found matching your criteria.</p>
        <button class="btn-clear" (click)="clearSearch()" *ngIf="searchName || searchCategory || minPrice || maxPrice">
          Clear Filters
        </button>
      </div>
    </ng-template>
  </section>

  <!-- Add Sweet Modal -->
  <div class="modal-overlay" *ngIf="showAddForm" (click)="cancelForm()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <h2>Add New Sweet</h2>
      <form class="sweet-form" (ngSubmit)="addSweet()" #addForm="ngForm">
        <input 
          type="text" 
          placeholder="Sweet Name" 
          [(ngModel)]="newSweet.name" 
          name="name"
          #nameInput="ngModel"
          required>
        <div class="error-message" *ngIf="nameInput.invalid && nameInput.touched">
          Sweet name is required
        </div>
        
        <input 
          type="text" 
          placeholder="Category" 
          [(ngModel)]="newSweet.category" 
          name="category"
          #categoryInput="ngModel"
          required>
        <div class="error-message" *ngIf="categoryInput.invalid && categoryInput.touched">
          Category is required
        </div>
        
        <input 
          type="number" 
          placeholder="Price" 
          [(ngModel)]="newSweet.price" 
          name="price"
          #priceInput="ngModel"
          min="0" 
          step="0.01"
          required>
        <div class="error-message" *ngIf="priceInput.invalid && priceInput.touched">
          Valid price is required (minimum 0)
        </div>
        
        <input 
          type="number" 
          placeholder="Quantity" 
          [(ngModel)]="newSweet.quantity" 
          name="quantity"
          #quantityInput="ngModel"
          min="0"
          required>
        <div class="error-message" *ngIf="quantityInput.invalid && quantityInput.touched">
          Valid quantity is required (minimum 0)
        </div>
        
        <textarea 
          placeholder="Description (optional)" 
          [(ngModel)]="newSweet.description" 
          name="description"
          rows="3">
        </textarea>
        
        <div class="form-buttons">
          <button type="submit" class="btn-save" [disabled]="addForm.invalid">Save Sweet</button>
          <button type="button" class="btn-cancel" (click)="cancelForm()">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Sweet Modal -->
  <div class="modal-overlay" *ngIf="showEditForm && editingSweet" (click)="cancelForm()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <h2>Edit Sweet</h2>
      <form class="sweet-form" (ngSubmit)="updateSweet()" #editForm="ngForm">
        <input 
          type="text" 
          placeholder="Sweet Name" 
          [(ngModel)]="editingSweet.name" 
          name="editName"
          #editNameInput="ngModel"
          required>
        <div class="error-message" *ngIf="editNameInput.invalid && editNameInput.touched">
          Sweet name is required
        </div>
        
        <input 
          type="text" 
          placeholder="Category" 
          [(ngModel)]="editingSweet.category" 
          name="editCategory"
          #editCategoryInput="ngModel"
          required>
        <div class="error-message" *ngIf="editCategoryInput.invalid && editCategoryInput.touched">
          Category is required
        </div>
        
        <input 
          type="number" 
          placeholder="Price" 
          [(ngModel)]="editingSweet.price" 
          name="editPrice"
          #editPriceInput="ngModel"
          min="0" 
          step="0.01"
          required>
        <div class="error-message" *ngIf="editPriceInput.invalid && editPriceInput.touched">
          Valid price is required (minimum 0)
        </div>
        
        <input 
          type="number" 
          placeholder="Quantity" 
          [(ngModel)]="editingSweet.quantity" 
          name="editQuantity"
          #editQuantityInput="ngModel"
          min="0"
          required>
        <div class="error-message" *ngIf="editQuantityInput.invalid && editQuantityInput.touched">
          Valid quantity is required (minimum 0)
        </div>
        
        <textarea 
          placeholder="Description (optional)" 
          [(ngModel)]="editingSweet.description" 
          name="editDescription"
          rows="3">
        </textarea>
        
        <div class="form-buttons">
          <button type="submit" class="btn-save" [disabled]="editForm.invalid">Update Sweet</button>
          <button type="button" class="btn-cancel" (click)="cancelForm()">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Toast Notification -->
  <div *ngIf="showToast" class="toast" [class.success]="toastType === 'success'" [class.error]="toastType === 'error'">
    {{ toastMessage }}
  </div>
</div>